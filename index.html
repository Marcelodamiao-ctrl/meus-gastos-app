<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💳 Meus Gastos Sincronizados</title>
    <style>
        :root {
            --primary: #007AFF;
            --success: #34C759;
            --danger: #FF3B30;
            --bg: #F2F2F7;
            --card: #FFFFFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, sans-serif;
            background: var(--bg);
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .card {
            background: var(--card);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        .status {
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .online { background: #d4ffd4; color: #155724; }
        .offline { background: #fff0d4; color: #856404; }
        
        .gasto-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h1>💳 Meus Gastos</h1>
        <div class="status offline" id="status">🔄 Iniciando...</div>
    </div>

    <div class="card">
        <h3>➕ Novo Gasto</h3>
        <input type="date" id="data">
        <input type="text" id="descricao" placeholder="O que você comprou?">
        <select id="categoria">
            <option value="Alimentação">🍕 Alimentação</option>
            <option value="Transporte">🚗 Transporte</option>
            <option value="Compras">🛍️ Compras</option>
            <option value="Lazer">🎮 Lazer</option>
            <option value="Saúde">🏥 Saúde</option>
            <option value="Outros">📦 Outros</option>
        </select>
        <input type="number" id="valor" placeholder="Valor R$" step="0.01">
        
        <button class="btn-primary" onclick="adicionarGasto()">💾 Salvar Gasto</button>
    </div>

    <div class="card">
        <h3>📊 Resumo</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <div style="font-size: 14px; color: #666;">Total Geral</div>
                <div style="font-size: 24px; font-weight: 700;">R$ <span id="totalGeral">0,00</span></div>
            </div>
            <div>
                <div style="font-size: 14px; color: #666;">Este Mês</div>
                <div style="font-size: 24px; font-weight: 700;">R$ <span id="totalMes">0,00</span></div>
            </div>
        </div>
        
        <button class="btn-success" onclick="sincronizarTudo()">🔄 Sincronizar Tudo</button>
        <button onclick="verPlanilha()" style="background: #5856D6; color: white; margin-top: 10px;">📊 Ver Planilha</button>
    </div>

    <div class="card">
        <h3>📝 Meus Gastos (<span id="totalGastos">0</span>)</h3>
        <div id="listaGastos">
            <div style="text-align: center; padding: 40px 20px; color: #666;">
                Nenhum gasto registrado ainda.
            </div>
        </div>
    </div>

    <!-- Formulário invisível para enviar dados -->
    <iframe name="hiddenFrame" class="hidden"></iframe>
    <form id="hiddenForm" action="SUA_URL_DO_GOOGLE_FORMS_AQUI" method="POST" target="hiddenFrame">
        <input type="hidden" name="entry.XXXXX_data" id="formData">
        <input type="hidden" name="entry.XXXXX_descricao" id="formDescricao">
        <input type="hidden" name="entry.XXXXX_categoria" id="formCategoria">
        <input type="hidden" name="entry.XXXXX_valor" id="formValor">
        <input type="hidden" name="entry.XXXXX_id" id="formId">
    </form>

    <script>
        // ✅ MÉTODO ALTERNATIVO: Dados locais com exportação manual
        let gastos = [];
        let gastosPendentes = [];
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date();
            document.getElementById('data').value = hoje.toISOString().split('T')[0];
            carregarDados();
        });
        
        function carregarDados() {
            // Sempre carrega apenas local por enquanto
            carregarDoLocal();
            atualizarInterface();
            atualizarStatus('📱 Modo local ativo', 'offline');
        }
        
        function carregarDoLocal() {
            const dadosLocais = localStorage.getItem('gastosApp');
            gastos = dadosLocais ? JSON.parse(dadosLocais) : [];
        }
        
        function salvarLocal() {
            localStorage.setItem('gastosApp', JSON.stringify(gastos));
        }
        
        function adicionarGasto() {
            const data = document.getElementById('data').value;
            const descricao = document.getElementById('descricao').value;
            const categoria = document.getElementById('categoria').value;
            const valor = parseFloat(document.getElementById('valor').value);
            
            if (!data || !descricao || !categoria || !valor || isNaN(valor)) {
                alert('❌ Preencha todos os campos!');
                return;
            }
            
            const novoGasto = {
                id: Date.now(),
                data: data,
                descricao: descricao,
                categoria: categoria,
                valor: valor,
                sincronizado: false,
                timestamp: new Date().toISOString()
            };
            
            // Adicionar localmente
            gastos.unshift(novoGasto);
            gastosPendentes.push(novoGasto);
            salvarLocal();
            atualizarInterface();
            
            // Limpar campos
            document.getElementById('descricao').value = '';
            document.getElementById('valor').value = '';
            
            atualizarStatus('✅ Salvo localmente (' + gastos.length + ' gastos)', 'offline');
            
            // Tentar sincronizar em segundo plano
            tentarSincronizarBackground();
        }
        
        function tentarSincronizarBackground() {
            // Tenta sincronizar os pendentes
            if (gastosPendentes.length > 0) {
                sincronizarPendentes();
            }
        }
        
        function sincronizarTudo() {
            if (gastosPendentes.length === 0) {
                atualizarStatus('✅ Todos os dados estão sincronizados', 'online');
                return;
            }
            
            atualizarStatus('🔄 Sincronizando ' + gastosPendentes.length + ' gastos...', 'offline');
            sincronizarPendentes();
        }
        
        function sincronizarPendentes() {
            // Método 1: Tentar via Google Forms se configurado
            if (typeof enviarViaGoogleForms === 'function') {
                gastosPendentes.forEach(gasto => {
                    if (!gasto.sincronizado) {
                        enviarViaGoogleForms(gasto);
                    }
                });
            }
            
            // Método 2: Exportar CSV como fallback
            setTimeout(() => {
                if (gastosPendentes.length > 0) {
                    atualizarStatus('📤 Pronto para exportar CSV', 'offline');
                    alert('💡 Dica: Use "Exportar CSV" para salvar na planilha manualmente');
                }
            }, 2000);
        }
        
        function atualizarInterface() {
            // Calcular totais
            let totalGeral = 0;
            let totalMes = 0;
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();
            
            gastos.forEach(gasto => {
                totalGeral += gasto.valor;
                const dataGasto = new Date(gasto.data);
                if (dataGasto.getMonth() === mesAtual && dataGasto.getFullYear() === anoAtual) {
                    totalMes += gasto.valor;
                }
            });
            
            document.getElementById('totalGeral').textContent = totalGeral.toFixed(2);
            document.getElementById('totalMes').textContent = totalMes.toFixed(2);
            document.getElementById('totalGastos').textContent = gastos.length;
            
            atualizarListaGastos();
        }
        
        function atualizarListaGastos() {
            const lista = document.getElementById('listaGastos');
            
            if (gastos.length === 0) {
                lista.innerHTML = '<div style="text-align: center; padding: 40px 20px; color: #666;">Nenhum gasto registrado ainda.</div>';
                return;
            }
            
            let html = '';
            gastos.forEach((gasto, index) => {
                const sincronizado = gasto.sincronizado ? '✅' : '📱';
                html += `
                    <div class="gasto-item">
                        <div style="font-weight: 600; margin-bottom: 4px;">${sincronizado} ${gasto.descricao}</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 4px;">
                            ${gasto.data} • ${gasto.categoria}
                        </div>
                        <div style="font-weight: 600; color: #FF3B30;">R$ ${gasto.valor.toFixed(2)}</div>
                        <button onclick="excluirGasto(${index})" style="background: #FF3B30; color: white; padding: 5px 10px; border: none; border-radius: 5px; font-size: 12px; margin-top: 5px;">Excluir</button>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
        }
        
        function excluirGasto(index) {
            if (confirm('Tem certeza que deseja excluir este gasto?')) {
                const gastoExcluido = gastos[index];
                gastos.splice(index, 1);
                
                // Remover dos pendentes se existir
                gastosPendentes = gastosPendentes.filter(g => g.id !== gastoExcluido.id);
                
                salvarLocal();
                atualizarInterface();
                atualizarStatus('🗑️ Gasto excluído', 'offline');
            }
        }
        
        function atualizarStatus(mensagem, tipo) {
            const status = document.getElementById('status');
            status.textContent = mensagem;
            status.className = `status ${tipo}`;
        }
        
        function verPlanilha() {
            window.open('https://docs.google.com/spreadsheets/d/11-gFodpaCOaDS9sP73iIxBpbpbiRbAZN4Ph0V7rcofk/edit', '_blank');
        }
        
        function exportarCSV() {
            if (gastos.length === 0) {
                alert('Nenhum dado para exportar!');
                return;
            }
            
            let csv = 'Data,Descrição,Categoria,Valor,ID\n';
            gastos.forEach(gasto => {
                csv += `"${gasto.data}","${gasto.descricao}","${gasto.categoria}",${gasto.valor},"${gasto.id}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gastos_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            atualizarStatus('📤 CSV exportado! Cole na planilha.', 'online');
        }
        
        // Adicionar botão de exportação
        document.addEventListener('DOMContentLoaded', function() {
            const card = document.querySelector('.card:nth-child(3)');
            const exportBtn = document.createElement('button');
            exportBtn.textContent = '📤 Exportar CSV';
            exportBtn.style.background = '#FF9500';
            exportBtn.style.color = 'white';
            exportBtn.style.marginTop = '10px';
            exportBtn.onclick = exportarCSV;
            card.appendChild(exportBtn);
        });
    </script>
</body>
</html>
